---
title: "D. Benchmarking with ProteinGym"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{D. Benchmarking with ProteinGym}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

Original version: 25 September, 2024

```{r setup, message = FALSE}
library(AlphaMissenseR)
library(dplyr)
library(ggplot2)
library(queryup)
```

# Introduction

Benchmarking is essential for assessing different variant effect prediction 
approaches, potentially aiding in decisions about which models are most suitable
for specific research questions or clinical applications. 

To evaluate the performance of AlphaMissense and its predictions, we integrate
with the [ProteinGym][pg_link] database, a comprehensive collection of
benchmarks aimed at comparing the ability of models that predict the effects of
protein mutations. It consists of an extensive dataset of deep mutational
scanning (DMS) assays covering approximately 2.7 million missense variants
across 217 experiments, as well as annotated human clinical variants for 2,525
proteins. DMS assays are highly valuable as they systematically test all
possible single mutations in a protein, recording their fitness effects. They
can reveal the impacts of both deleterious and beneficial mutations on fitness,
offering insights into protein structure and activity.

Furthermore, ProteinGym provides several standardized model evaluation 
metric scores ("AUC", "MCC", "NDCG", "Spearman", "Top_recall") for 62 models 
calculated across the 217 DMS assays, offering a consistent and extensive 
benchmarking framework across approaches.

[pg_link]: https://proteingym.org/
[Notin_link]: https://papers.nips.cc/paper_files/paper/2023/hash/cac723e5ff29f65e3fcbb0739ae91bee-Abstract-Datasets_and_Benchmarks.html
[AlphaMissense]: https://www.science.org/doi/10.1126/science.adg7492

# Access ProteinGym datasets through `ExperimentHub`.

The ProteinGym DMS assays can be accessed by querying `ExperimentHub`.

```{r access_dms}
eh <- ExperimentHub::ExperimentHub()
dms_data <- eh[['EH9555']]

head(names(dms_data))
```

We show names of the first 6 DMS assays in the list. Next, we can access the 
first assay and take a closer look at the data.frame.

```{r dms assay 1}
head(dms_data[[1]])
```

Each element of the list is an individual DMS assay with the following
information for each column: the UniProt protein identifier, the DMS 
experiment assay identifier, the mutant at a given protein position, the mutated
protein sequence, the recorded DMS score, and a binary DMS score bin 
categorizing whether the mutation has an affect on fitness (1) or not (0). For 
more details, reference the publication from Notin et al. [2023][Notin_link].

A supplementary table of AlphaMissense pathogencity scores for ~1.6 M 
substitutions matching those in the ProteinGym DMS assays is provided by Cheng 
et al. [2023][AlphaMissense], and can also be accessed through `ExperimentHub`.

```{r am_scores}
am_scores <- eh[['EH9554']]
am_scores
```

The `data.frame` shows the `DMS_id` matching to a ProteinGym assay, the 
UniProt entry name of the protein evaluated, the mutation and position, and 
the aggregated AlphaMissense score for that mutation. For more details about 
the table, reference the [AlphaMissense][AlphaMissense] paper.

# Compare DMS scores and AlphaMissense predictions

The DMS scores serve as an experimental measure to evaluate the accuracy of
AlphaMissense mutation effect predictions. For a given protein, we can plot the 
correlation between the two measures and report their Spearman correlation. 

Here, we demonstrate using the "NUD15_HUMAN" assay. First, we filter both 
datasets to the chosen assay.

```{r dms_am_NUD15}
NUD15_dms <- dms_data[["NUD15_HUMAN_Suiter_2020"]]

NUD15_am <- am_scores |> 
    filter(DMS_id == "NUD15_HUMAN_Suiter_2020")
```

Wrangle and merge the DMS and AlphaMissense tables together by the UniProt and 
mutant identifers.

```{r dms_am_wrangle}
NUD15_am <- NUD15_am |>
    mutate(Uniprot_ID = "Q9NV35")

merged_table <- 
    left_join(
        NUD15_am, NUD15_dms, 
        by = c("Uniprot_ID" = "UniProt_id", "variant_id" = "mutant"),
        relationship = "many-to-many"
    ) |>
    select(Uniprot_ID, variant_id, AlphaMissense, DMS_score) |> 
    na.omit()
```

Now, we plot the correlation.

```{r dms_am_plot}
correlation_plot <- 
    merged_table |> 
    ggplot(
        aes(y = .data$AlphaMissense, x = .data$DMS_score)
    ) +
    geom_bin2d(bins = 60) +
    scale_fill_continuous(type = "viridis") +
    xlab("DMS score") +
    ylab("AlphaMissense score") +
    theme_classic() +
    theme(
        axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        axis.title.y = element_text(size = 16, vjust = 2),
        axis.title.x = element_text(size = 16, vjust = 0),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 16)
    )

correlation_plot
```

If a mutation has a strong affect on fitness in the DMS assay, we would expect 
expect it to be more pathogenic if altered (higher AlphaMissense score). 
Therefore, a stronger negative correlation represents a tighter relationship 
between the two measures. We see this with the NUD15 protein.

We can print the Spearman correlation.

```{r}
cor.test(
    merged_table$AlphaMissense, merged_table$DMS_score, 
    method=c("spearman"), 
    exact = FALSE
)
```
The correlation is r = -0.67 and statistically significant.


# Benchmark AlphaMissense with other variant effect prediction models

Now we can calculate the Spearman correlation across multiple DMS assays in 
which we have corresponding AlphaMissense scores, and use this metric to 
benchmark across multiple models aimed at predicting mutation effects. For this
analysis, we will load in the metric scores ("AUC", "MCC", "NDCG", "Spearman", "Top_recall") for 62 models calculated across the 217 DMS assays from the 
ProteinGym database available through `ExperimentHub`.

```{r load_metrics}
metrics_scores <- eh[['EH9593']]
```

This is a `list` object where each `data.frame` is shows one of the five
evaluation metric scores calculated on the DMS assays for 62 models. 
For demonstration purposes, let's select 10 assays that overlap between the 
AlphaMissense and ProteinGym databases.

```{r choose10}
chosen_assays <- c(
    "A0A1I9GEU1_NEIME_Kennouche_2019", 
    "A0A192B1T2_9HIV1_Haddox_2018", 
    "ADRB2_HUMAN_Jones_2020", 
    "BRCA1_HUMAN_Findlay_2018", 
    "CALM1_HUMAN_Weile_2017",
    "GAL4_YEAST_Kitzman_2015", 
    "Q59976_STRSQ_Romero_2015", 
    "UBC9_HUMAN_Weile_2017", 
    "TPK1_HUMAN_Weile_2017",
    "YAP1_HUMAN_Araya_2012")
```

Subset the AlphaMissense scores, DMS scores, and the model metrics to these 10
chosen assays.

```{r}
am_subset <- 
    am_scores |> 
    filter(DMS_id %in% chosen_assays)

dms_subset <- 
    dms_data[names(dms_data) %in% chosen_assays]

metric_subset <- 
    metrics_scores |> 
    pluck("Spearman") |> 
    filter(DMS_ID %in% chosen_assays)
```

```{r}

```

```{r am_replace_ids}
## Grab all UniProt accessions for DMS assay
unique_ids <- 
    dms_data |> 
    sapply(function(x) x|> 
            pull(UniProt_id) %>% unique()) |>
    unlist() |>
    unique()

## Replace AlphaMissense entry name ID observations with accession
query <- list("accession_id" = unique_ids)
res <- query_uniprot(query = query, show_progress = TRUE)
entry_names <- res |> pull(`Entry Name`)

## Create a lookup table
lookup <-
    cbind(entry_names, query[[1]]) |>
    as.data.frame()

new_cols <- c('entry_name', 'accession')

lookup <- 
    lookup |> 
    rename_with(
        ~ new_cols, 
            .cols = c('entry_names', 'V2')
    )

new_names <- c(entry_names = "entry_name", V2 = "accession")

lookup <- 
    lookup |> 
    rename(all_of(new_names))

# Replace the values via lookup table
am_updated <- 
    am_scores |>
    left_join(
        lookup, 
        by = c("Uniprot_ID" = "entry_name")
    ) |>
    mutate(
        Uniprot_ID = coalesce(accession, Uniprot_ID)
    ) |> 
    select(-accession)

# Put it into a list split by protein
am_list <- am_updated |>  
    group_by(Uniprot_ID) |> 
    group_split()
```

We have our AlphaMissense table with UniProt IDs that match our DMS assays.
Now find the Spearman correlation averaged for each protein.

```{r correlate_proteins}
library(data.table)

# Combine the list elements
combined_df <- rbindlist(dms_data)
```

```{r plot_P37023, fig.width = 7}
clinvar_plot(uniprotId = "P37023")
```

We returned a `ggplot` object which overlays ClinVar classifications onto
AlphaMissense predicted scores. Blue, gray, and red colors represent
pathogenicity classifications for "likely benign", "ambiguous", or "likely
pathogenic", respectively. Large, bolded points are ClinVar variants colored
according to their clinical classification, while smaller points in the
background are AlphaMissense predictions.
We can note a discrepancy between the clinically-validated annotations and the
AlphaMissense predictions around position 50. AlphaMissense seems to predict
several variants in that region as likely benign, while ClinVar identifies them
as pathogenic.
Because the ClinVar dataset is not exhaustive (not all proteins have been
clinically-assessed), there may be proteins where information is not available.
In this case, the function will provide an error.
Remember to disconnect from the database.
```{r, close_db}
db_disconnect_all()
```
# Session information {.unnumbered}
```{r}
sessionInfo()
```